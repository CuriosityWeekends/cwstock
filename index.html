<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CW Stock System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

/* =============== THEME =============== */

:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;

  --text:#f8fafc;
  --muted:#94a3b8;

  --primary:#2563eb;
  --success:#22c55e;
}


/* =============== RESET =============== */

*{
  box-sizing:border-box;
  font-family:Inter,sans-serif;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
}


/* =============== LAYOUT =============== */

.app{
  max-width:900px;
  margin:auto;
  padding:25px;
  min-height:100vh;
}


/* =============== HEADER =============== */

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;

  padding:20px;

  border:1px solid var(--border);
  border-radius:14px;
}

.header h2{
  margin:0;
}

.header span{
  color:var(--primary);
}


/* =============== CARDS =============== */

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:25px;
  margin-top:25px;
}


/* =============== FORM =============== */

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

@media(max-width:650px){
  .grid{grid-template-columns:1fr}
}

label{
  font-size:13px;
  color:var(--muted);
}

input{
  width:100%;
  padding:12px;

  border-radius:10px;
  background:#020617;
  border:1px solid var(--border);

  color:var(--text);
  margin-top:6px;
}

input:focus{
  outline:none;
  border-color:var(--primary);
}


/* =============== PRODUCTS =============== */

.product{
  display:flex;
  justify-content:space-between;
  align-items:center;

  padding:14px 16px;
  border-radius:12px;

  border:1px solid var(--border);
  margin-bottom:12px;
}

.product small{
  color:var(--muted);
}


/* =============== CART =============== */

.cart{
  margin-top:12px;
  padding:12px;

  border-radius:12px;
  background:#020617;
  border:1px solid var(--border);
}


/* =============== BUTTON =============== */

.btn{
  padding:10px 16px;
  border:none;
  border-radius:8px;

  background:var(--primary);
  color:white;

  cursor:pointer;
  font-weight:500;
}

.btn:hover{
  opacity:.9;
}

.btn.success{
  background:var(--success);
}


/* =============== PREVIEW =============== */

.preview{
  font-size:14px;
  line-height:1.7;
}

.preview hr{
  border:none;
  border-top:1px solid var(--border);
  margin:12px 0;
}


/* =============== RETURN BOX =============== */

.return-box{
  border:1px solid var(--border);
  border-radius:12px;
  padding:15px;
  margin-bottom:12px;

  display:flex;
  justify-content:space-between;
  align-items:center;
}

.return-box small{
  color:var(--muted);
}


/* =============== STATUS =============== */

.status{
  text-align:center;
  font-size:18px;
  padding:25px;
}

</style>
</head>


<body>

<div class="app">


<!-- HEADER -->
<div class="header">

<h2>CuriosityWeekends <span>Stock</span></h2>

<div style="color:var(--muted)">
Inventory System
</div>

</div>


<!-- ================= ISSUE SECTION ================= -->

<div class="card">


<h3>üì¶ Issue Items</h3>


<!-- BASIC INFO -->

<div class="grid">

<div>
<label>Name</label>
<input id="name">
</div>

<div>
<label>Class</label>
<input id="cls">
</div>

<div>
<label>Phone</label>
<input id="phone">
</div>

<div>
<label>Email</label>
<input id="email">
</div>

<div>
<label>Return Date</label>
<input id="ret" type="date">
</div>

</div>


<!-- PRODUCTS -->

<h4 style="margin-top:25px">Select Items</h4>

<div id="products"></div>

<div class="cart" id="cart">
No items selected
</div>


<!-- PROJECT -->

<h4 style="margin-top:25px">Project Details</h4>

<div class="grid">

<div>
<label>Purpose</label>
<input id="purpose">
</div>

<div>
<label>Members</label>
<input id="members">
</div>

<div>
<label>GitHub</label>
<input id="git">
</div>

</div>


<!-- PREVIEW -->

<h4 style="margin-top:25px">Preview</h4>

<div class="preview" id="preview"></div>


<!-- SUBMIT -->

<div style="margin-top:20px;text-align:center">

<button class="btn" onclick="submitData()">
Submit & Download PDF
</button>

</div>

</div>


<!-- ================= RETURN SECTION ================= -->

<div class="card">

<h3>üîÅ Return Items</h3>

<div id="returnList">
Loading...
</div>

</div>


<!-- ================= STATUS ================= -->

<div class="card" id="statusBox" style="display:none">

<div class="status" id="statusText"></div>

</div>


</div>


<script>

/* ================= CONFIG ================= */

const API =
"https://script.google.com/macros/s/AKfycbwd_xE9NtNjLAjfYWZLjygRijPxFm090e2zYNNlkvJk8X-m-NbKu5AbREWR-sdJr0YQTw/exec";


let cart=[];


/* ================= LOAD PRODUCTS ================= */

fetch(API+"?action=getProducts")
.then(r=>r.json())
.then(data=>{

  let box=document.getElementById("products");

  data.forEach(p=>{

    let d=document.createElement("div");

    d.className="product";

    d.innerHTML=`

      <div>
        <b>${p[1]}</b><br>
        <small>Stock: ${p[3]}</small>
      </div>

      <button class="btn"
        onclick="addItem('${p[1]}')">
        Add
      </button>

    `;

    box.appendChild(d);

  });

});


/* ================= CART ================= */

function addItem(name){

  let q=prompt("Enter quantity");

  if(!q || q<=0) return;

  cart.push({name,qty:+q});

  renderCart();
}


function renderCart(){

  let box=document.getElementById("cart");

  if(!cart.length){
    box.innerHTML="No items selected";
    return;
  }

  let h="<b>Selected Items</b><br>";

  cart.forEach(i=>{
    h+=`‚Ä¢ ${i.name} x${i.qty}<br>`;
  });

  box.innerHTML=h;

  makePreview();
}


/* ================= PREVIEW ================= */

function makePreview(){

  let p=document.getElementById("preview");

  let items="";

  cart.forEach(i=>{
    items+=`‚Ä¢ ${i.name} x${i.qty}<br>`;
  });


  p.innerHTML=`

<b>Name:</b> ${name.value}<br>
<b>Class:</b> ${cls.value}<br>
<b>Phone:</b> ${phone.value}<br>
<b>Email:</b> ${email.value}<br>

<hr>

<b>Items:</b><br>${items}

<hr>

<b>Purpose:</b> ${purpose.value}<br>
<b>Members:</b> ${members.value}<br>
<b>GitHub:</b> ${git.value}<br>

<b>Return:</b> ${ret.value}

`;

}


/* ================= SUBMIT ================= */

function submitData(){

  if(!cart.length){
    alert("Add items first");
    return;
  }


  document.getElementById("statusBox")
    .style.display="block";

  statusText.innerHTML="‚è≥ Submitting...";


  let data={

    name:name.value,
    class:cls.value,
    phone:phone.value,
    email:email.value,

    items:formatItems(),

    purpose:purpose.value,
    members:members.value,
    github:git.value,

    returnDate:ret.value,

    cart:cart
  };


  fetch(API,{
    method:"POST",
    mode:"no-cors",
    body:JSON.stringify(data)
  });


  setTimeout(()=>{

    statusText.innerHTML=
      "<span style='color:var(--success)'>‚úî Submitted</span><br><br>"+
      "Download and submit to manager.";

    makePDF(data);

    cart=[];
    renderCart();

    loadReturns();

  },1500);

}


/* ================= FORMAT ================= */

function formatItems(){

  let t="";

  cart.forEach(i=>{
    t+=`${i.name} x${i.qty}, `;
  });

  return t.slice(0,-2);
}


/* ================= PDF ================= */

function makePDF(d){

  const { jsPDF } = window.jspdf;

  let pdf=new jsPDF();


  pdf.setFillColor(37,99,235);
  pdf.rect(0,0,210,22,"F");

  pdf.setTextColor(255,255,255);
  pdf.setFontSize(15);

  pdf.text("CW Inventory Receipt",105,15,{align:"center"});


  pdf.setTextColor(0,0,0);
  pdf.setFontSize(11);

  let y=30;


  pdf.roundedRect(15,y,180,30,3,3);

  pdf.text("Student Details",18,y+7);

  y+=12;

  pdf.text("Name: "+d.name,20,y);
  pdf.text("Class: "+d.class,120,y);

  y+=7;

  pdf.text("Phone: "+d.phone,20,y);
  pdf.text("Email: "+d.email,120,y);

  y+=18;


  pdf.text("Issued Items",18,y);
  y+=5;

  pdf.line(15,y,195,y);
  y+=6;


  d.cart.forEach(i=>{

    pdf.text(i.name,25,y);
    pdf.text("x"+i.qty,170,y);

    y+=6;
  });


  y+=6;


  pdf.text("Purpose: "+d.purpose,20,y); y+=6;
  pdf.text("Members: "+d.members,20,y); y+=6;
  pdf.text("GitHub: "+d.github,20,y); y+=10;


  pdf.text("Return Date: "+d.returnDate,20,y);
  y+=14;

  pdf.text("Lab Seal & Signature:",20,y);

  pdf.roundedRect(20,y+4,60,22,2,2);


  pdf.setFontSize(9);

  pdf.text(
    "Generated by CuriosityWeekends",
    105,
    290,
    {align:"center"}
  );


  pdf.save("CW_Receipt.pdf");
}


/* ================= RETURNS ================= */

function loadReturns(){

  fetch(API+"?action=getIssued")
  .then(r=>r.json())
  .then(data=>{

    let box=document.getElementById("returnList");

    box.innerHTML="";


    if(!data.length){
      box.innerHTML="‚úÖ No pending returns";
      return;
    }


    data.forEach((r,i)=>{

      const row=i+2;


      let d=document.createElement("div");

      d.className="return-box";

      d.innerHTML=`

<div>
<b>${r[1]}</b><br>
${r[5]}<br>
<small>${r[4]}</small>
</div>

<button class="btn success"
 onclick="returnItem(${row})">
Return
</button>

`;

      box.appendChild(d);

    });

  });
}


function returnItem(row){

  if(!confirm("Confirm return?")) return;


  fetch(API,{
    method:"POST",
    mode:"no-cors",

    body:JSON.stringify({
      action:"returnItem",
      row:row
    })
  });


  alert("Returned");

  loadReturns();
}


/* ================= INIT ================= */

loadReturns();

</script>

</body>
</html>
