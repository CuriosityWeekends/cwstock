<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CW Stock System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

/* THEME */
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --text:#f8fafc;
  --muted:#94a3b8;
  --primary:#2563eb;
  --success:#22c55e;
}

/* RESET */
*{box-sizing:border-box;font-family:Inter,sans-serif;}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
}

/* LAYOUT */
.app{
  max-width:900px;
  margin:auto;
  padding:25px;
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px;
  border:1px solid var(--border);
  border-radius:14px;
}

.header span{color:var(--primary);}

/* CARD */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:25px;
  margin-top:25px;
}

/* FORM */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

@media(max-width:650px){
  .grid{grid-template-columns:1fr}
}

label{font-size:13px;color:var(--muted);}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
  margin-top:6px;
}

/* PRODUCTS */
.product{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
  border-radius:12px;
  border:1px solid var(--border);
  margin-bottom:12px;
}

.product small{color:var(--muted);}

/* CART */
.cart{
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:#020617;
  border:1px solid var(--border);
}

/* BUTTON */
.btn{
  padding:10px 16px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:white;
  cursor:pointer;
}

.btn.success{background:var(--success);}

/* PREVIEW */
.preview{font-size:14px;line-height:1.7;}

.preview hr{
  border:none;
  border-top:1px solid var(--border);
  margin:12px 0;
}

/* RETURN */
.return-box{
  border:1px solid var(--border);
  border-radius:12px;
  padding:15px;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
}

/* STATUS */
.status{text-align:center;font-size:18px;padding:25px;}

</style>
</head>

<body>

<div class="app">

<!-- HEADER -->
<div class="header">
<h2>CuriosityWeekends <span>Stock</span></h2>
<div style="color:var(--muted)">Inventory System</div>
</div>


<!-- ISSUE -->
<div class="card">

<h3>üì¶ Issue Items</h3>

<div class="grid">

<div>
<label>Name</label>
<input id="userName" placeholder="Your name">
</div>

<div>
<label>Class</label>
<input id="cls">
</div>

<div>
<label>Phone</label>
<input id="phone">
</div>

<div>
<label>Email</label>
<input id="email">
</div>

<div>
<label>Return Date</label>
<input id="ret" type="date">
</div>

</div>


<h4 style="margin-top:25px">Select Items</h4>

<div id="products"></div>

<div class="cart" id="cart">No items selected</div>


<h4 style="margin-top:25px">Project Details</h4>

<div class="grid">

<div><label>Purpose</label><input id="purpose"></div>
<div><label>Members</label><input id="members"></div>
<div><label>GitHub</label><input id="git"></div>

</div>


<h4 style="margin-top:25px">Preview</h4>

<div class="preview" id="preview"></div>


<div style="margin-top:20px;text-align:center">
<button class="btn" onclick="submitData()">
Submit & Download PDF
</button>
</div>

</div>


<!-- RETURN -->
<div class="card">

<h3>üîÅ Return Items</h3>

<div id="returnList">Loading...</div>

</div>


<!-- STATUS -->
<div class="card" id="statusBox" style="display:none">
<div class="status" id="statusText"></div>
</div>

</div>


<script>

/* CONFIG */

const API="https://script.google.com/macros/s/AKfycbwd_xE9NtNjLAjfYWZLjygRijPxFm090e2zYNNlkvJk8X-m-NbKu5AbREWR-sdJr0YQTw/exec";

let cart=[];


/* LOAD PRODUCTS */

fetch(API+"?action=getProducts")
.then(r=>r.json())
.then(data=>{

  const box=document.getElementById("products");

  data.forEach(p=>{

    const d=document.createElement("div");

    d.className="product";

    d.innerHTML=`

<div>
<b>${p[1]}</b><br>
<small>Stock: ${p[3]}</small>
</div>

<button class="btn" onclick="addItem('${p[1]}')">Add</button>

`;

    box.appendChild(d);

  });

});


/* CART */

function addItem(name){

  let q=prompt("Enter quantity");

  if(!q||q<=0) return;

  cart.push({name,qty:+q});

  renderCart();
}


function renderCart(){

  const box=document.getElementById("cart");

  if(!cart.length){
    box.innerHTML="No items selected";
    return;
  }

  let h="<b>Selected Items</b><br>";

  cart.forEach(i=>{
    h+=`‚Ä¢ ${i.name} x${i.qty}<br>`;
  });

  box.innerHTML=h;

  makePreview();
}


/* PREVIEW */

function makePreview(){

  const n=document.getElementById("userName").value;
  const c=cls.value;
  const ph=phone.value;
  const em=email.value;
  const pu=purpose.value;
  const me=members.value;
  const gi=git.value;
  const re=ret.value;


  let items="";

  cart.forEach(i=>{
    items+=`‚Ä¢ ${i.name} x${i.qty}<br>`;
  });


  preview.innerHTML=`

<b>Name:</b> ${n}<br>
<b>Class:</b> ${c}<br>
<b>Phone:</b> ${ph}<br>
<b>Email:</b> ${em}<br>

<hr>

<b>Items:</b><br>${items}

<hr>

<b>Purpose:</b> ${pu}<br>
<b>Members:</b> ${me}<br>
<b>GitHub:</b> ${gi}<br>

<b>Return:</b> ${re}

`;
}


/* SUBMIT */

function submitData(){

  if(!cart.length){
    alert("Add items first");
    return;
  }


  statusBox.style.display="block";
  statusText.innerHTML="‚è≥ Submitting...";


  const data={

    name:document.getElementById("userName").value,
    class:cls.value,
    phone:phone.value,
    email:email.value,

    purpose:purpose.value,
    members:members.value,
    github:git.value,

    returnDate:ret.value,

    cart:cart
  };


  fetch(API,{
    method:"POST",
    mode:"no-cors",
    body:JSON.stringify(data)
  });


  setTimeout(()=>{

    statusText.innerHTML="‚úî Submitted";

    makePDF(data);

    cart=[];
    renderCart();

    loadReturns();

  },1500);

}


/* PDF */

function makePDF(d){

  const {jsPDF}=window.jspdf;

  const pdf=new jsPDF();

  pdf.text("CW Inventory Receipt",105,15,{align:"center"});

  let y=30;

  pdf.text("Name: "+d.name,20,y); y+=7;
  pdf.text("Class: "+d.class,20,y); y+=7;
  pdf.text("Phone: "+d.phone,20,y); y+=7;
  pdf.text("Email: "+d.email,20,y); y+=10;


  d.cart.forEach(i=>{
    pdf.text(i.name+" x"+i.qty,20,y);
    y+=6;
  });


  pdf.text("Return: "+d.returnDate,20,y+10);

  pdf.save("CW_Receipt.pdf");
}


/* RETURNS */

function loadReturns(){

  fetch(API+"?action=getIssued")
  .then(r=>r.json())
  .then(data=>{

    const box=document.getElementById("returnList");

    box.innerHTML="";


    if(!data.length){
      box.innerHTML="‚úÖ No pending returns";
      return;
    }


    data.forEach((r,i)=>{

      const row=i+2;

      const d=document.createElement("div");

      d.className="return-box";

      d.innerHTML=`

<div>
<b>${r[1]}</b><br>
${r[5]}
</div>

<button class="btn success"
onclick="returnItem(${row})">Return</button>

`;

      box.appendChild(d);

    });

  });
}


function returnItem(row){

  if(!confirm("Confirm return?")) return;


  fetch(API,{
    method:"POST",
    mode:"no-cors",
    body:JSON.stringify({
      action:"returnItem",
      row:row
    })
  });


  alert("Returned");

  loadReturns();
}


/* INIT */

loadReturns();

</script>

</body>
</html>